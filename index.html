<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ú–æ—ò —Ä–∞—Å–ø–æ—Ä–µ–¥ v5.0 Stable</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #f8fafc; --surface: #ffffff; --text: #0f172a; --text-muted: #64748b;
            --accent: #0f172a; --border: #e2e8f0; --card-radius: 20px; --primary: #3b82f6;
        }
        
        .dark-mode {
            --bg: #020617; --surface: #0f172a; --text: #f8fafc; --text-muted: #94a3b8;
            --accent: #f8fafc; --border: #1e293b;
        }

        * { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.3s; }

        .app-bar { padding: 50px 24px 10px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .app-bar h1 { margin: 0; font-size: 24px; font-weight: 800; }
        
        .theme-btn { background: var(--surface); border: 1px solid var(--border); padding: 8px; border-radius: 12px; cursor: pointer; color: var(--text); }

        .main-content { flex: 1; overflow-y: auto; padding: 10px 16px 100px; }
        .card { background: var(--surface); border-radius: var(--card-radius); padding: 20px; border: 1px solid var(--border); margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        select { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 15px; font-weight: 600; appearance: none; margin-bottom: 10px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2.5' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; }

        .mesto-row { display: flex; flex-direction: column; padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .mesto-row:last-child { border-bottom: none; }
        .mesto-name { font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .worker-name { font-size: 16px; font-weight: 700; margin-top: 2px; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn { padding: 16px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-outline { background: var(--surface); border: 1px solid var(--border); color: var(--text); }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; opacity: 0; transition: 0.3s; z-index: 2000; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="toast">–ö–æ–ø–∏—Ä–∞–Ω–æ —É –ø—Ä–∏–≤—Ä–µ–º–µ–º—É –º–µ–º–æ—Ä–∏—ò—É</div>

<div class="app-bar">
    <h1 id="page-title">–ü–ª–∞–Ω</h1>
    <button class="theme-btn" onclick="toggleTheme()">üåì</button>
</div>

<div class="main-content">
    <div id="setup-area" class="hidden">
        <div class="card" style="text-align: center;">
            <p style="font-weight: 600;">–ù–∏—ò–µ —É—á–∏—Ç–∞–Ω —Ä–∞—Å–ø–æ—Ä–µ–¥ –∑–∞ –æ–≤–∞—ò –º–µ—Å–µ—Ü.</p>
            <label class="btn btn-primary">
                –£—á–∏—Ç–∞—ò –ï–∫—Ü–µ–ª <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden">
            </label>
        </div>
    </div>

    <div id="main-area">
        <div class="controls">
            <select id="danSel"></select>
            <select id="smenaSel"></select>
        </div>
        
        <div class="card" id="lista-prikaz"></div>

        <div class="actions">
            <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">–ù–æ–≤–∏ —Ñ–∞—ò–ª</button>
            <button class="btn btn-primary" onclick="copyToClipboard()">–ö–æ–ø–∏—Ä–∞—ò —Ç–µ–∫—Å—Ç</button>
        </div>
    </div>
</div>

<script>
let rawData = [];
let replacements = {};
const MESTA = ["–ü–æ—Ä—Ç–∏—Ä–Ω–∏—Ü–∞", "–ù–∏–∑–≤–æ–¥–Ω–∞ –≥–ª–∞–≤–∞", "–ú–æ—Å—Ç", "–£–∑–≤–æ–¥–Ω–∞ –≥–ª–∞–≤–∞", "–†–∞–∑–≤–æ–¥–Ω–æ –ø–æ—Å—Ç—Ä–æ—ò–µ—ö–µ", "–ü—É—Ç –ö–ª–∞–¥–æ–≤–æ –¢–µ–∫–∏—ò–∞", "–ú–∞–≥–∞—Ü–∏–Ω –ö–∞—Ä–∞—Ç–∞—à", "–î–µ–ø–æ–Ω–∏—ò–∞ –ù–æ–≤–∏ –°–∏–ø", "–°–ø–æ—Ä—Ç—Å–∫–∞ —Ö–∞–ª–∞", "–£–ø—Ä–∞–≤–Ω–∞ –∑–≥—Ä–∞–¥–∞", "–ü–∞—Ç—Ä–æ–ª–∞ 1", "–ü–∞—Ç—Ä–æ–ª–∞ 2"];

// –£—á–∏—Ç–∞–≤–∞—ö–µ –∏–∑ –º–µ–º–æ—Ä–∏—ò–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –ø–æ–∫—Ä–µ—Ç–∞—ö—É
window.onload = () => {
    const savedData = localStorage.getItem('rasporedData');
    if (savedData) {
        rawData = JSON.parse(savedData);
        setupFilters();
    } else {
        document.getElementById('main-area').classList.add('hidden');
        document.getElementById('setup-area').classList.remove('hidden');
    }
    if (localStorage.getItem('darkTheme') === 'true') document.body.classList.add('dark-mode');
};

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkTheme', document.body.classList.contains('dark-mode'));
}

document.getElementById('fileInput').onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(ex) {
        const data = new Uint8Array(ex.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});
        
        rawData = [];
        let currentMesto = "";
        rows.forEach(row => {
            if(!row || row.length < 2) return;
            let rowText = row.join(" ").toUpperCase();
            MESTA.forEach(m => { if(rowText.includes(m.toUpperCase())) currentMesto = m; });
            if(/^\d+/.test(String(row[0]).trim()) && currentMesto) {
                rawData.push({ ime: String(row[1]).trim(), mesto: currentMesto, raspored: row.slice(2).map(s => String(s || "").trim().toUpperCase()) });
            }
        });

        localStorage.setItem('rasporedData', JSON.stringify(rawData));
        setupFilters();
        document.getElementById('setup-area').classList.add('hidden');
        document.getElementById('main-area').classList.remove('hidden');
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};

function setupFilters() {
    const danSel = document.getElementById('danSel');
    const smenaSel = document.getElementById('smenaSel');
    danSel.innerHTML = "";
    smenaSel.innerHTML = '<option value="1">–ü—Ä–≤–∞ —Å–º–µ–Ω–∞</option><option value="2">–î—Ä—É–≥–∞ —Å–º–µ–Ω–∞</option><option value="3">–¢—Ä–µ—õ–∞ —Å–º–µ–Ω–∞</option>';
    
    const maxD = rawData[0].raspored.length;
    const today = new Date().getDate();
    for(let i=1; i<=maxD; i++) {
        let opt = document.createElement('option');
        opt.value = i; opt.innerText = i + ". –§–µ–±—Ä—É–∞—Ä";
        danSel.appendChild(opt);
    }
    danSel.value = today <= maxD ? today : 1;
    danSel.onchange = renderList;
    smenaSel.onchange = renderList;
    renderList();
}

function renderList() {
    const dan = document.getElementById('danSel').value;
    const smena = document.getElementById('smenaSel').value;
    const cont = document.getElementById('lista-prikaz');
    let html = "";
    
    MESTA.forEach(m => {
        const r = rawData.find(rad => rad.mesto === m && rad.raspored[dan-1] === smena);
        const key = `${dan}-${smena}-${m}`;
        const radnikIme = r ? r.ime : "‚Äî";
        const prikazIme = replacements[key] ? `${replacements[key]} —É–º–µ—Å—Ç–æ ${radnikIme}` : radnikIme;
        
        html += `<div class="mesto-row" onclick="swapWorker('${m}')">
                    <span class="mesto-name">${m}</span>
                    <span class="worker-name">${prikazIme}</span>
                 </div>`;
    });
    cont.innerHTML = html;
}

function swapWorker(mesto) {
    const dan = document.getElementById('danSel').value;
    const smena = document.getElementById('smenaSel').value;
    const –Ω–æ–≤–æ–ò–º–µ = prompt("–£–Ω–µ—Å–∏ –∏–º–µ –∑–∞ –∑–∞–º–µ–Ω—É (–æ—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ –¥–∞ –ø–æ–Ω–∏—à—Ç–∏—à):");
    const key = `${dan}-${smena}-${mesto}`;
    if (–Ω–æ–≤–æ–ò–º–µ === null) return;
    if (–Ω–æ–≤–æ–ò–º–µ === "") delete replacements[key];
    else replacements[key] = –Ω–æ–≤–æ–ò–º–µ;
    renderList();
}

function generateText() {
    const dan = document.getElementById('danSel').value;
    const smena = document.getElementById('smenaSel').value;
    const smenaNaziv = document.getElementById('smenaSel').options[document.getElementById('smenaSel').selectedIndex].text;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–∞—ö–µ –¥–∞—Ç—É–º–∞ –∑–∞ —Ç—Ä–µ—õ—É —Å–º–µ–Ω—É
    let d1 = new Date(2026, 1, dan); // –§–µ–±—Ä—É–∞—Ä 2026
    let datumStr = "";
    if (smena === "3") {
        let d2 = new Date(2026, 1, parseInt(dan) + 1);
        datumStr = `${String(d1.getDate()).padStart(2,'0')}.${String(d1.getMonth()+1).padStart(2,'0')}./${String(d2.getDate()).padStart(2,'0')}.${String(d2.getMonth()+1).padStart(2,'0')}.${d2.getFullYear()}.`;
    } else {
        datumStr = `${String(d1.getDate()).padStart(2,'0')}.${String(d1.getMonth()+1).padStart(2,'0')}.${d1.getFullYear()}.`;
    }

    let text = `–Ç–ï–†–î–ê–ü 1 –ö–õ–ê–î–û–í–û\n${datumStr}\n${smenaNaziv}\n\n`;
    MESTA.forEach(m => {
        const r = rawData.find(rad => rad.mesto === m && rad.raspored[dan-1] === smena);
        const key = `${dan}-${smena}-${m}`;
        const –∏–º–µ = replacements[key] ? `${replacements[key]} —É–º–µ—Å—Ç–æ ${r?r.ime:'‚Äî'}` : (r?r.ime:'‚Äî');
        text += `${m}: ${–∏–º–µ}\n`;
    });
    return text;
}

async function copyToClipboard() {
    await navigator.clipboard.writeText(generateText());
    const t = document.getElementById('toast');
    t.style.opacity = '1';
    setTimeout(() => t.style.opacity = '0', 2000);
}
</script>
</body>
</html>
